# name: test/sql/dd_read_arrow_integration.test_slow
# description: Integration test for dd_read_arrow with dazzleduck server
# group: [sql]
#
# This test requires a running dazzleduck server:
#   docker run -ti -p 59307:59307 -p 8081:8081 dazzleduck/dazzleduck:latest --conf warehouse=/data
#
# Run this test with: ./build/release/test/unittest --test-dir . "*dd_read_arrow_integration*"

require dazzle_duck

# Test basic SQL query - SELECT literal values
query III
SELECT * FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT 1 as a, 2 as b, 3 as c');
----
1	2	3

# Test SQL query with multiple rows
query II
SELECT * FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT * FROM (VALUES (1, ''hello''), (2, ''world''), (3, ''test'')) AS t(id, name)');
----
1	hello
2	world
3	test

# Test SQL query with different data types
query IIII
SELECT * FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT 42 as int_col, 3.14 as double_col, ''text'' as string_col, true as bool_col');
----
42	3.14	text	true

# Test projection pushdown - only select specific columns
query I
SELECT a FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT 1 as a, 2 as b, 3 as c');
----
1

query I
SELECT c FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT 1 as a, 2 as b, 3 as c');
----
3

# Test filter pushdown
query II
SELECT * FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT * FROM (VALUES (1, ''a''), (2, ''b''), (3, ''c'')) AS t(id, name)') WHERE id > 1;
----
2	b
3	c

query II
SELECT * FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT * FROM (VALUES (1, ''a''), (2, ''b''), (3, ''c'')) AS t(id, name)') WHERE id = 2;
----
2	b

# Test combined projection and filter pushdown
query I
SELECT name FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT * FROM (VALUES (1, ''a''), (2, ''b''), (3, ''c'')) AS t(id, name)') WHERE id >= 2;
----
b
c

# Test projection with expression - only column 'a' should be fetched, 'a+1' computed locally
query II
SELECT a, a+1 FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT 1 as a, 2 as b, 3 as c');
----
1	2

# Test projection with multiple expressions from same column
query III
SELECT a, a*2, a+10 FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT 5 as a, 100 as b');
----
5	10	15

# Test projection selecting middle column only
query I
SELECT b FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT 1 as a, 2 as b, 3 as c, 4 as d, 5 as e');
----
2

# Test projection selecting non-contiguous columns
query II
SELECT a, e FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT 1 as a, 2 as b, 3 as c, 4 as d, 5 as e');
----
1	5

# Test projection in different order than source
query II
SELECT c, a FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT 1 as a, 2 as b, 3 as c');
----
3	1

# Test projection with alias
query II
SELECT a as first_col, c as last_col FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT 1 as a, 2 as b, 3 as c');
----
1	3

# Test with NULL values
query II
SELECT * FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT * FROM (VALUES (1, ''a''), (2, NULL), (3, ''c'')) AS t(id, name)');
----
1	a
2	NULL
3	c

# Test IS NULL filter
query II
SELECT * FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT * FROM (VALUES (1, ''a''), (2, NULL), (3, ''c'')) AS t(id, name)') WHERE name IS NULL;
----
2	NULL

# Test IS NOT NULL filter
query II
SELECT * FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT * FROM (VALUES (1, ''a''), (2, NULL), (3, ''c'')) AS t(id, name)') WHERE name IS NOT NULL;
----
1	a
3	c

# Test aggregation on remote data
query I
SELECT SUM(id) FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT * FROM (VALUES (1), (2), (3), (4), (5)) AS t(id)');
----
15

query I
SELECT COUNT(*) FROM dd_read_arrow('http://localhost:8081', sql := 'SELECT * FROM (VALUES (1), (2), (3)) AS t(id)');
----
3
