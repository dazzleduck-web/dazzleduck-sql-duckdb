# name: test/sql/dd_read_arrow_split.test_slow
# description: Integration test for dd_read_arrow split mode and dd_splits function
# group: [sql]
#
# This test requires a running dazzleduck server with plan API support:
#
#   docker run -d --name ducklake-test -p 8082:8081 -p 59308:59307 \
#       dazzleduck/dazzleduck:latest \
#       --conf 'dazzleduck_server.access_mode=RESTRICTED' \
#       --conf 'dazzleduck_server.startup_script_provider.script_location="/startup/ducklake.sql"'
#
# This creates a ducklake table at: demo_db.main.demo
# Schema: key STRING, value STRING, partition INT
#
# Run this test with: ./build/release/test/unittest --test-dir . "*dd_read_arrow_split*"

require dazzle_duck

# Clear default HTTP skip behavior - these tests require a running server
set ignore_error_messages

# =============================================================================
# Basic Split Mode Tests
# =============================================================================

# Test basic split mode query returns rows
query T
SELECT COUNT(*) > 0 FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'));
----
true

# Test split mode with SELECT * works
statement ok
SELECT * FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')) LIMIT 10;

# =============================================================================
# Data Integrity Tests - Split vs Non-Split
# =============================================================================

# Test split mode returns same count as non-split mode
query T
SELECT
    (SELECT COUNT(*) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))) =
    (SELECT COUNT(*) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := false, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')));
----
true

# Test split mode returns same sum of partition column as non-split mode
query T
SELECT
    (SELECT SUM(partition) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))) =
    (SELECT SUM(partition) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := false, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')));
----
true

# Test split mode returns same distinct count as non-split mode
query T
SELECT
    (SELECT COUNT(DISTINCT key) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))) =
    (SELECT COUNT(DISTINCT key) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := false, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')));
----
true

# =============================================================================
# Projection Pushdown Tests
# =============================================================================

# Test projection pushdown - select only 'key' column
query T
SELECT COUNT(*) > 0 FROM (
    SELECT key FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))
);
----
true

# Test projection pushdown - select only 'partition' column
query T
SELECT COUNT(*) > 0 FROM (
    SELECT partition FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))
);
----
true

# Test projection pushdown - select two columns
query T
SELECT COUNT(*) > 0 FROM (
    SELECT key, partition FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))
);
----
true

# Test projection pushdown - select columns in different order
query T
SELECT COUNT(*) > 0 FROM (
    SELECT partition, value, key FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))
);
----
true

# =============================================================================
# Filter Pushdown Tests
# =============================================================================

# Test filter pushdown with partition column (split mode)
query T
SELECT COUNT(*) >= 0 FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))
WHERE partition >= 0;
----
true

# Test filter pushdown with partition column (non-split mode)
query T
SELECT COUNT(*) >= 0 FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := false, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))
WHERE partition >= 0;
----
true

# Test filter with equality
query T
SELECT COUNT(*) >= 0 FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))
WHERE partition = 0;
----
true

# Test filter with string column
query T
SELECT COUNT(*) >= 0 FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))
WHERE key = 'k00';
----
true

# =============================================================================
# Split=false Tests (Non-Split Mode)
# =============================================================================

# Test split=false works (should use single query path, not plan API)
query T
SELECT COUNT(*) > 0 FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := false, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'));
----
true

# =============================================================================
# Query Processing Tests
# =============================================================================

# Test split mode with LIMIT
statement ok
SELECT * FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')) LIMIT 5;

# Test split mode with ORDER BY and LIMIT
statement ok
SELECT * FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')) ORDER BY key LIMIT 10;

# Test split mode with ORDER BY partition
statement ok
SELECT * FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')) ORDER BY partition LIMIT 10;

# =============================================================================
# Aggregation Tests
# =============================================================================

# Test aggregation - SUM
query T
SELECT SUM(partition) IS NOT NULL FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'));
----
true

# Test aggregation - COUNT with GROUP BY
statement ok
SELECT partition, COUNT(*) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))
GROUP BY partition
ORDER BY partition
LIMIT 10;

# Test aggregation - MIN/MAX
query T
SELECT MIN(partition) <= MAX(partition) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'));
----
true

# =============================================================================
# Multiple Query / Consistency Tests
# =============================================================================

# Test that multiple split queries can run in sequence
query T
SELECT
    (SELECT COUNT(*) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))) > 0 AND
    (SELECT COUNT(*) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))) > 0;
----
true

# Test concurrent/repeated split queries return consistent results
query T
WITH
    split1 AS (SELECT COUNT(*) as c FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))),
    split2 AS (SELECT COUNT(*) as c FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')))
SELECT split1.c = split2.c FROM split1, split2;
----
true

# Test split mode in CTE
query T
WITH remote_data AS (
    SELECT * FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))
)
SELECT COUNT(*) > 0 FROM remote_data;
----
true

# Test split mode in subquery
query T
SELECT COUNT(*) > 0 FROM (
    SELECT * FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))
) sub;
----
true

# =============================================================================
# Column Type Tests
# =============================================================================

# Test string column (key) works correctly
statement ok
SELECT key, LENGTH(key) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')) LIMIT 5;

# Test string column (value) works correctly
statement ok
SELECT value, LENGTH(value) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')) LIMIT 5;

# Test integer column (partition) works correctly
statement ok
SELECT partition, partition + 1 FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')) LIMIT 5;

# Test all columns together
statement ok
SELECT key, value, partition FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')) LIMIT 5;

# =============================================================================
# dd_splits Function Tests
# =============================================================================

# Test dd_splits returns at least one split
query T
SELECT COUNT(*) > 0 FROM dd_splits('http://localhost:8082', source_table := 'demo_db.main.demo', auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'));
----
true

# Test dd_splits returns correct columns
query IIIIII
SELECT endpoints IS NOT NULL, query_id IS NOT NULL OR query_id IS NULL, query IS NOT NULL, producer_id IS NOT NULL, split_size IS NOT NULL OR split_size IS NULL, query_checksum IS NOT NULL OR query_checksum IS NULL
FROM dd_splits('http://localhost:8082', source_table := 'demo_db.main.demo', auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))
LIMIT 1;
----
true	true	true	true	true	true

# Test dd_splits with sql parameter
query T
SELECT COUNT(*) > 0 FROM dd_splits('http://localhost:8082', sql := 'SELECT partition FROM demo_db.main.demo WHERE partition >= 0', auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'));
----
true

# Test dd_splits query contains expected content
query T
SELECT query LIKE '%demo_db.main.demo%' FROM dd_splits('http://localhost:8082', source_table := 'demo_db.main.demo', auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')) LIMIT 1;
----
true

# Test dd_splits with split_size parameter - large split_size should return only one split
query I
SELECT COUNT(*) FROM dd_splits('http://localhost:8082', source_table := 'demo_db.main.demo', split_size := 1000000, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'));
----
1

