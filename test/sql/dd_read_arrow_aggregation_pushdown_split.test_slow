# name: test/sql/dd_read_arrow_aggregation_pushdown_split.test_slow
# description: Integration test for dd_read_arrow aggregation pushdown in split mode
# group: [sql]
#
# This test requires a running dazzleduck server with plan API support:
#
#   docker run -d --name ducklake-test -p 8082:8081 -p 59308:59307 \
#       dazzleduck/dazzleduck:latest \
#       --conf 'dazzleduck_server.access_mode=RESTRICTED' \
#       --conf 'dazzleduck_server.startup_script_provider.script_location="/startup/ducklake.sql"'
#
# This creates a ducklake table at: demo_db.main.demo
# Schema: key STRING, value STRING, partition INT
#
# Run this test with: ./build/release/test/unittest --test-dir . "*aggregation_pushdown_split*"

require dazzleduck

set ignore_error_messages

# =============================================================================
# Split-Safe Aggregation Pushdown (split mode)
# These should be pushed down: COUNT(*), COUNT(col), SUM, MIN, MAX
# =============================================================================

# Test: COUNT(*) in split mode - split-safe, should be pushed down
query T
SELECT count(*) > 0 FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'));
----
true

# Test: SUM in split mode - split-safe
query T
SELECT sum(partition) IS NOT NULL FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'));
----
true

# Test: MIN/MAX in split mode - split-safe
query T
SELECT min(partition) <= max(partition) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'));
----
true

# Test: GROUP BY with split-safe aggregates
statement ok
SELECT partition, count(*), sum(partition) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')) GROUP BY partition ORDER BY partition LIMIT 10;

# =============================================================================
# Split vs Non-Split Consistency for Split-Safe Aggregates
# =============================================================================

# Verify COUNT(*) returns same result in split vs non-split mode
query T
SELECT
    (SELECT count(*) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))) =
    (SELECT count(*) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := false, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')));
----
true

# Verify SUM returns same result in split vs non-split mode
query T
SELECT
    (SELECT sum(partition) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))) =
    (SELECT sum(partition) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := false, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')));
----
true

# Verify MIN returns same result in split vs non-split mode
query T
SELECT
    (SELECT min(partition) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))) =
    (SELECT min(partition) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := false, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')));
----
true

# Verify MAX returns same result in split vs non-split mode
query T
SELECT
    (SELECT max(partition) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))) =
    (SELECT max(partition) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := false, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')));
----
true

# =============================================================================
# NOT Split-Safe: AVG in split mode
# AVG is NOT split-safe, so pushdown should be skipped and local execution used.
# The result should still be correct (falls back to local aggregation).
# =============================================================================

# Test: AVG in split mode - should NOT be pushed down but still return correct result via local fallback
query T
SELECT avg(partition) IS NOT NULL FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'));
----
true

# AVG result should match between split and non-split mode
query T
SELECT
    (SELECT avg(partition) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))) =
    (SELECT avg(partition) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := false, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')));
----
true

# =============================================================================
# NOT Split-Safe: COUNT(DISTINCT) in split mode
# COUNT(DISTINCT) is NOT split-safe, should fall back to local execution.
# =============================================================================

# Test: COUNT DISTINCT in split mode - should NOT be pushed down but still correct via local fallback
query T
SELECT count(DISTINCT key) > 0 FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'));
----
true

# COUNT DISTINCT result should match between split and non-split mode
query T
SELECT
    (SELECT count(DISTINCT key) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))) =
    (SELECT count(DISTINCT key) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := false, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')));
----
true

# =============================================================================
# Mixed: query with both split-safe and non-split-safe aggregates
# If ANY aggregate is not split-safe, entire pushdown is skipped.
# =============================================================================

# Test: SUM + AVG together in split mode - should NOT push down (avg not split-safe)
# but should still return correct results via local fallback
query T
SELECT sum(partition) IS NOT NULL AND avg(partition) IS NOT NULL FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'));
----
true

# Verify mixed agg results match between split and non-split
query T
SELECT
    (SELECT sum(partition) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := true, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}'))) =
    (SELECT sum(partition) FROM dd_read_arrow('http://localhost:8082', source_table := 'demo_db.main.demo', split := false, auth_token := dd_login('http://localhost:8082', 'admin', 'admin', '{"database":"demo_db","schema":"main","table":"demo"}')));
----
true
