# name: test/sql/bloom_filter.test
# description: test bloom filter scalar functions
# group: [sql]

require dazzle_duck

# Test dd_bloom_filter_create - basic case
query I
SELECT octet_length(dd_bloom_filter_create(['a', 'b', 'c'])) > 0;
----
true

# Test dd_bloom_filter_contains - element exists
query I
SELECT dd_bloom_filter_contains(dd_bloom_filter_create(['apple', 'banana', 'cherry']), 'banana');
----
true

# Test dd_bloom_filter_contains - element does not exist
query I
SELECT dd_bloom_filter_contains(dd_bloom_filter_create(['apple', 'banana', 'cherry']), 'orange');
----
false

# Test dd_bloom_filter_contains - empty array
query I
SELECT dd_bloom_filter_contains(dd_bloom_filter_create([]), 'anything');
----
false

# Test dd_bloom_filter_contains_all - all elements exist
query I
SELECT dd_bloom_filter_contains_all(dd_bloom_filter_create(['a', 'b', 'c', 'd', 'e']), ['a', 'b', 'c']);
----
true

# Test dd_bloom_filter_contains_all - not all elements exist
query I
SELECT dd_bloom_filter_contains_all(dd_bloom_filter_create(['a', 'b', 'c']), ['a', 'x']);
----
false

# Test dd_bloom_filter_contains_all - empty needle array
query I
SELECT dd_bloom_filter_contains_all(dd_bloom_filter_create(['a', 'b', 'c']), []);
----
true

# Test with custom bits_per_element
query I
SELECT dd_bloom_filter_contains(dd_bloom_filter_create(['hello', 'world'], 20), 'hello');
----
true

# Test with custom bits_per_element and hash functions
query I
SELECT dd_bloom_filter_contains(dd_bloom_filter_create(['hello', 'world'], 15, 5), 'world');
----
true

# Test with NULL array
query I
SELECT dd_bloom_filter_create(NULL);
----
NULL

# Test dd_bloom_filter_contains with NULL bloom filter
query I
SELECT dd_bloom_filter_contains(NULL, 'test');
----
NULL

# Test dd_bloom_filter_contains with NULL value
query I
SELECT dd_bloom_filter_contains(dd_bloom_filter_create(['a', 'b']), NULL);
----
NULL

# Test with column references
query I
SELECT dd_bloom_filter_contains(bf, 'a') FROM (
    SELECT dd_bloom_filter_create(arr) as bf FROM (
        VALUES (['a', 'b', 'c']), (['x', 'y', 'z'])
    ) AS t(arr)
);
----
true
false

# Test dd_bloom_filter_contains_all with column references
query I
SELECT dd_bloom_filter_contains_all(bf, ['a', 'b']) FROM (
    SELECT dd_bloom_filter_create(arr) as bf FROM (
        VALUES (['a', 'b', 'c', 'd']), (['a', 'x', 'y', 'z']), (['x', 'y', 'z'])
    ) AS t(arr)
);
----
true
false
false

# Test with larger array
query I
SELECT dd_bloom_filter_contains(
    dd_bloom_filter_create(list_transform(range(1, 101), lambda x: 'item_' || x::VARCHAR)),
    'item_50'
);
----
true

# Test that non-existent element returns false
query I
SELECT dd_bloom_filter_contains(
    dd_bloom_filter_create(list_transform(range(1, 101), lambda x: 'item_' || x::VARCHAR)),
    'item_999'
);
----
false

# Test with special characters
query I
SELECT dd_bloom_filter_contains(dd_bloom_filter_create(['hello world', 'foo@bar.com', 'test\ttab']), 'foo@bar.com');
----
true

# Test with unicode
query I
SELECT dd_bloom_filter_contains(dd_bloom_filter_create(['hello', 'world']), 'hello');
----
true

# Test bloom filter size varies with bits_per_element (use larger arrays to exceed minimum size)
query I
SELECT octet_length(dd_bloom_filter_create(list_transform(range(1, 20), lambda x: x::VARCHAR), 10)) < octet_length(dd_bloom_filter_create(list_transform(range(1, 20), lambda x: x::VARCHAR), 64));
----
true

